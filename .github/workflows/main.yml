name: Release

on:
    workflow_dispatch:
    push:
        branches:
            - move-to-github-actions


jobs:
    build:
        runs-on: ubuntu-latest
        if: "!contains(github.event.head_commit.message, '[ci-skip]')"
        steps:
          - name: Checkout
            uses: actions/checkout@v2
            
          - name: Prepare
            id: prep
            run: |
              DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/baseimage
              VERSION=latest
              SHORTREF=${GITHUB_SHA::8}
              
              # If this is git tag, use the tag name as a docker tag
              if [[ $GITHUB_REF == refs/tags/* ]]; then
                VERSION=${GITHUB_REF#refs/tags/v}
              fi
              TAGS="${DOCKER_IMAGE}:${VERSION},${DOCKER_IMAGE}:${SHORTREF}"
              
              # If the VERSION looks like a version number, assume that
              # this is the most recent version of the image and also
              # tag it 'latest'.
              if [[ $VERSION =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
                TAGS="$TAGS,${DOCKER_IMAGE}:latest"
              fi
              
              # Set output parameters.
              
              echo ::set-output name=tags::${TAGS}
              echo ::set-output name=docker_image::${DOCKER_IMAGE}

          - name: Set up QEMU
            uses: docker/setup-qemu-action@v1
            with:
              platforms: amd64,arm64

          - name: Set up Docker Buildx
            id: buildx
            uses: docker/setup-buildx-action@v1
            with:
              install: true
              version: latest
              driver-opts: image=moby/buildkit:latest

          - name: Login to Docker Hub
            if: github.event_name != 'pull_request'
            uses: docker/login-action@v1
            with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}
              
          - name: Build and Push
            uses: docker/build-push-action@v2
            with:
              build-args: VERSION=focal-1.0.0-test
              builder: ${{ steps.buildx.outputs.name }}
              context: image
              platforms: amd64,arm64
              push: true
              tags: ${{ steps.prep.outputs.tags }}
